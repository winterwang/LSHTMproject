---
title: "NDNS multilevel LCA CW2CB2 or CW2CB3"
author: "Chaochen Wang"
date: "19 July 2018"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    nature:
      highlightLines: true
editor_options: 
  chunk_output_type: console
---


# Steps of conducting a multilevel LCA 

- Firstly, we ignored the multilevel structure of the data and estimated a series of traditional LC models to determine the number of classes at the observational-level;
- Next, a series of MLCA models were fitted to account for the multi-level structrure of the data. In these models, the number of observational-level classes was based on the best fitting LCA model from the first step, and the LCA model at the individual-level was estimated to identify the number of individual-level latent classes;
- Thirdly, when number of individual-level latent classes is defined based on the previous stage, observational-level classes was modified (one class lower and one class higher than in the second step), to see the effect of changing level 1 classes and confirm the best fitting model.


## How to decide the number of classes in level 1 and/or level 2 data

The number of classes in level 1 were determined by 

1) the evaluation of model fit indices, including the Akaike information criterion (AIC), Bayesian information criterion (BIC), adjusted Bayesian information criterion (aBIC) where smaller values indicate better, and entropy which is a statistic that summarizes latent class probabilities where values near 1 indicate better latent class separation; 

2) the Lo-Mendell-Rubin Likelihood Ratio Test (LMR-LRT) \parencite{lo2001testing, nylund2007deciding} which compares $q$ vs. $q-1$ class models, where $q$ is the number of latent classes; 

3) pattern interpretability. 

4) In the step of performing multilevel LCA, where LMR-LRT was not available, same rules of model fit indices and pattern interpretability were used to determine the optimal combination of latent classes in level 1 and level 2. 

# Level 1 classes selection


- In this analysis, within each hour of the day carbohydrates intake was defined as: 
    - not eating; 
    - eating and carbohydrates contributed less than 50% of energy;
    - eating and carbohydrates contributed higher or equal to 50% of energy.


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(RColorBrewer)
library(plyr)
library(tidyverse)
library(dplyr)
library(epiDisplay)
library(scales)
library(readr)
rm(list=ls(all=TRUE))
# load("~/Documents/LSHTMproject/Rcode/day4LCA1_6.Rdata")

library(kableExtra)
dt <- read.csv("../LSHTMproject/Tablecsv/ndns_level1only.csv", header = T)
names(dt) <- c("N of classes", "N of free parameters","log-likelihood",  "AIC", "BIC", "aBIC", "Entropy", "Lo-Mendel-Rubin LRT")
dt[1,8] <- "--"
dt[2,8] <- "< 0.0001"
dt[3,8] <- "< 0.0001"
kable(dt, digits = 3, row.names = FALSE, align = "c",
              format = "html", caption = "Level 1 class selection. (All data, n = 6155, 24483 data points)") %>%
 kable_styling(font_size = 16, 
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center", full_width = FALSE) %>% 
  row_spec(c(2,3), bold = T, color = "white", background = "#D7261E") %>% 
  footnote(general = "Abbreviation: N, number; AIC, Akaike information criterion; BIC, Bayesian information criterion; aBIC, adjusted BIC; Entropy, a pseudo-r-squared index; Lo-Mendel-Rubin LRT, likelihood ratio test comparing q classes models with q-1 classes models.")
```


From what is shown in the table that, although AIC, BIC, aBIC or entropy are improving with increasing n of classes, however, the Lo-Mendell-Rubun likelihood ratio test suggested that **n of classes higher than 4 did not fit the data necessarily better**. The null hypothesis of the LRT is that the fit of a n-class model is equal to that of the (n-1)-class model. So that p-value less than 0.05 indicates that the more complex model (the one with more latent classes) provides better fit to the data. We show the results from 2 classes (CW = 2) below. 

## Fit information for each model (combination of level 1 and level 2 classes)


```{r echo=FALSE}
rm(list=ls(all=TRUE))
# load("~/Documents/LSHTMproject/Rcode/day4LCA1_6.Rdata")

library(kableExtra)
dt <- read.csv("../LSHTMproject/Tablecsv/Mixed_50.csv", header = T)
names(dt) <- c("Model", "1 class","2 classes",  "3 classes", "4 classes", "5 classes", "6 classes")
dt[is.na(dt)] <- ""
# library(formattable)
dt %>% 
  # mutate(
  #   `2 classes` = cell_spec(`2 classes`, color = ifelse())) %>% 
  kable(escape = F, 
        digits = 3, row.names = FALSE, align = "l",
        format = "html", caption = "Models Specification") %>% 
  add_header_above(c(" ", "Number of level 1 classes" = 6)) %>% 
  group_rows("Fixed effects model", 1, 5) %>%
  group_rows("Random effects model", 6, 20) %>%
  add_indent(c(2:5,7:10,12:15,17:20)) %>% 
  kable_styling(font_size = 16, 
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center", full_width = FALSE) %>% 
  #row_spec(c(2,3), bold = T, color = "white", background = "#D7261E") %>% 
  footnote(general = "Abbreviation: No, number; BIC, Bayesian information criterion; Entropy, a pseudo-r-squared index; Lo-Mendel-Rubin LRT, likelihood ratio test comparing q classes models with q-1 classes models.")
```



# (CW = 2) Level 1 latent classes 

## Visualisation of level 1 latent classes 

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

CW2CB2 <- read_table2("results/50NDNS_CW2CB2.txt",
                         col_names = FALSE)

names(CW2CB2) <- c("H0",
                      "H1",
                      "H2",
                      "H3",
                      "H4",
                      "H5",
                      "H6",
                      "H7",
                      "H8",
                      "H9",
                      "H10",
                      "H11",
                      "H12",
                      "H13",
                      "H14",
                      "H15",
                      "H16",
                      "H17",
                      "H18",
                      "H19",
                      "H20",
                      "H21",
                      "H22",
                      "H23",
                      "ID_DAY",
                      "AGE",
                      "SEX",
                      "CPROB1",
                      "CPROB2",
                      "CPROB3",
                      "CPROB4",
                      # "CPROB5",
                      # "CPROB6",
                      "CB",
                      "CW",
                      "MLCJOINT",
                      "ID")

pp <- CW2CB2 %>% 
  group_by(CW) %>% 
  summarise(H0_0 = sum(H0 == 0)/length(H0), 
            H0_1 = sum(H0 == 1)/length(H0), 
            H0_2 = sum(H0 == 2)/length(H0),
            H1_0 = sum(H1 == 0)/length(H1),
            H1_1 = sum(H1 == 1)/length(H1), 
            H1_2 = sum(H1 == 2)/length(H1),
            H2_0 = sum(H2 == 0)/length(H2),
            H2_1 = sum(H2 == 1)/length(H2), 
            H2_2 = sum(H2 == 2)/length(H2),
            H3_0 = sum(H3 == 0)/length(H3),
            H3_1 = sum(H3 == 1)/length(H3), 
            H3_2 = sum(H3 == 2)/length(H3),
            H4_0 = sum(H4 == 0)/length(H4),
            H4_1 = sum(H4 == 1)/length(H4), 
            H4_2 = sum(H4 == 2)/length(H4),
            H5_0 = sum(H5 == 0)/length(H5),
            H5_1 = sum(H5 == 1)/length(H5), 
            H5_2 = sum(H5 == 2)/length(H5),
            H6_0 = sum(H6 == 0)/length(H6),
            H6_1 = sum(H6 == 1)/length(H6), 
            H6_2 = sum(H6 == 2)/length(H6),
            H7_0 = sum(H7 == 0)/length(H7),
            H7_1 = sum(H7 == 1)/length(H7), 
            H7_2 = sum(H7 == 2)/length(H7),
            H8_0 = sum(H8 == 0)/length(H8),
            H8_1 = sum(H8 == 1)/length(H8), 
            H8_2 = sum(H8 == 2)/length(H8),
            H9_0 = sum(H9 == 0)/length(H9),
            H9_1 = sum(H9 == 1)/length(H9), 
            H9_2 = sum(H9 == 2)/length(H9),
            H10_0 = sum(H10 == 0)/length(H10),
            H10_1 = sum(H10 == 1)/length(H10), 
            H10_2 = sum(H10 == 2)/length(H10),
            H11_0 = sum(H11 == 0)/length(H11),
            H11_1 = sum(H11 == 1)/length(H11), 
            H11_2 = sum(H11 == 2)/length(H11),
            H12_0 = sum(H12 == 0)/length(H12),
            H12_1 = sum(H12 == 1)/length(H12), 
            H12_2 = sum(H12 == 2)/length(H12),
            H13_0 = sum(H13 == 0)/length(H13),
            H13_1 = sum(H13 == 1)/length(H13), 
            H13_2 = sum(H13 == 2)/length(H13),
            H14_0 = sum(H14 == 0)/length(H14),
            H14_1 = sum(H14 == 1)/length(H14), 
            H14_2 = sum(H14 == 2)/length(H14),
            H15_0 = sum(H15 == 0)/length(H15),
            H15_1 = sum(H15 == 1)/length(H15), 
            H15_2 = sum(H15 == 2)/length(H15),
            H16_0 = sum(H16 == 0)/length(H16),
            H16_1 = sum(H16 == 1)/length(H16), 
            H16_2 = sum(H16 == 2)/length(H16),
            H17_0 = sum(H17 == 0)/length(H17),
            H17_1 = sum(H17 == 1)/length(H17), 
            H17_2 = sum(H17 == 2)/length(H17),
            H18_0 = sum(H18 == 0)/length(H18),
            H18_1 = sum(H18 == 1)/length(H18), 
            H18_2 = sum(H18 == 2)/length(H18),
            H19_0 = sum(H19 == 0)/length(H19),
            H19_1 = sum(H19 == 1)/length(H19), 
            H19_2 = sum(H19 == 2)/length(H19),
            H20_0 = sum(H20 == 0)/length(H20),
            H20_1 = sum(H20 == 1)/length(H20), 
            H20_2 = sum(H20 == 2)/length(H20),
            H21_0 = sum(H21 == 0)/length(H21),
            H21_1 = sum(H21 == 1)/length(H21), 
            H21_2 = sum(H21 == 2)/length(H21),
            H22_0 = sum(H22 == 0)/length(H22),
            H22_1 = sum(H22 == 1)/length(H22), 
            H22_2 = sum(H22 == 2)/length(H22),
            H23_0 = sum(H23 == 0)/length(H23),
            H23_1 = sum(H23 == 1)/length(H23), 
            H23_2 = sum(H23 == 2)/length(H23))



pp_long <- pp %>% 
  gather(Hour, Prob, -CW) %>% 
  separate(Hour, into = c("HourN", "Carbo"), sep = "_") 




pp_long$HourN <- factor(pp_long$HourN, levels = c("H0","H1" ,"H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10","H11","H12","H13","H14","H15","H16","H17","H18","H19","H20","H21","H22","H23"))
```




```{r echo=FALSE, fig.height=5, fig.width=14, message=FALSE, warning=FALSE, cache=TRUE}
library(ggthemr)
ggthemr("fresh", layout = "scientific")
library(ggplot2)


ggplot(pp_long[pp_long$CW == 1, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.5) + 
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 18), 
        axis.line = element_line(colour = "black"), 
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        legend.text = element_text(size = 15), 
        legend.title = element_text(size = 15) 
        # legend.position = "bottom", 
        # legend.direction = "horizontal"
  ) + 
  labs(title = "Class 1 Lunch at 1 pm high carb breakfast", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") + 
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))



ggplot(pp_long[pp_long$CW == 2, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.5) + 
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 18), 
        axis.line = element_line(colour = "black"), 
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        legend.text = element_text(size = 15), 
        legend.title = element_text(size = 15) 
        # legend.position = "bottom", 
        # legend.direction = "horizontal"
  ) + 
  labs(title = "Class 2 Lunch at noon, eat until late", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") + 
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))


# 
# 
# ggplot(pp_long[pp_long$Class == 3, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
#   geom_point(size = 3) + 
#   geom_line(size = 1.5) + 
#   theme(axis.title = element_text(size = 18), 
#         axis.text = element_text(size = 18), 
#         axis.line = element_line(colour = "black"), 
#         panel.border = element_blank(), 
#         panel.background = element_blank(), 
#         legend.text = element_text(size = 15), 
#         legend.title = element_text(size = 15) 
#         # legend.position = "bottom", 
#         # legend.direction = "horizontal"
#   ) + 
#   labs(title = "Class 3 normal lunch at noon", x = "Hour of the day", y = "Probability",
#        color = "Carbohydrate\nintake") + 
#   scale_color_discrete(labels = c("< 50%", ">= 50%")) + 
#   ylim(c(0,1))
# 
# 
# 
# ggplot(pp_long[pp_long$Class == 4, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
#   geom_point(size = 3) + 
#   geom_line(size = 1.5) + 
#   theme(axis.title = element_text(size = 18), 
#         axis.text = element_text(size = 18), 
#         axis.line = element_line(colour = "black"), 
#         panel.border = element_blank(), 
#         panel.background = element_blank(), 
#         legend.text = element_text(size = 15), 
#         legend.title = element_text(size = 15) 
#         # legend.position = "bottom", 
#         # legend.direction = "horizontal"
#   ) + 
#   labs(title = "Class 4 Low carb all day", x = "Hour of the day", y = "Probability",
#        color = "Carbohydrate\nintake") + 
#   scale_color_discrete(labels = c("< 50%", ">= 50%")) + 
#   ylim(c(0,1))
```



## Visualisation of level 2 latent classes (CB = 2)




```{r echo=FALSE, fig.height=6, fig.width=7, message=FALSE, warning=FALSE, cache=TRUE}

ndnsNNN <- read_csv("results/ndnsNNN.dat")
dt <- ndnsNNN[, c(2,5)]
names(dt) <- c("ID_DAY", "DayofWeek")


CW2CB2 <- CW2CB2 %>% 
  left_join(dt, by = "ID_DAY")


chart.data <- CW2CB2 %>% 
  group_by(CB, CW) %>% 
  tally %>% 
  group_by(CB) %>% 
  mutate(pct = n/sum(n))

chart.data <- ddply(chart.data, .(CB),
                     transform, pos = cumsum(pct) - (0.5 * pct))

chart.data$CW <- factor(chart.data$CW, levels = c("2", "1"), 
                        labels = c("Lunch at 1 pm high carb breakfast", "Lunch at noon, eat until late"))
chart.data$CB <- factor(chart.data$CB, levels = c("1", "2"), 
                        labels = c("Individual class 1\n(66.63%)",  "Individual class 2\n(33.37%)"))



library(ggthemr)
ggthemr("dust", layout = "scientific")
ggplot() + 
  geom_bar(aes(y = pct, x = CB, fill = CW), data = chart.data, width = 0.6,
           stat="identity") + 
  geom_text(data=chart.data, aes(x = CB, y = pos, label = paste0(sprintf("%1.1f", pct*100),"%")),
            size=4, colour="white", family="Atlas Grotesk Medium") + 
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank(), 
        axis.title = element_text(size = 18), 
        axis.text = element_text(size = 15), 
        axis.line = element_line(colour = "black"), 
        plot.title=element_text(family="Atlas Grotesk Medium"),
        text=element_text(family="Atlas Grotesk Light")) + 
  labs(title = "Multilevel latent class solution", x = "Between Individual classes", y = "Percentage") +
  scale_y_continuous(labels=percent)
```






```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

CW2CB3 <- read_table2("results/50NDNS_CW2CB3.txt",
                         col_names = FALSE)

names(CW2CB3) <- c("H0",
                      "H1",
                      "H2",
                      "H3",
                      "H4",
                      "H5",
                      "H6",
                      "H7",
                      "H8",
                      "H9",
                      "H10",
                      "H11",
                      "H12",
                      "H13",
                      "H14",
                      "H15",
                      "H16",
                      "H17",
                      "H18",
                      "H19",
                      "H20",
                      "H21",
                      "H22",
                      "H23",
                      "ID_DAY",
                      "AGE",
                      "SEX",
                      "CPROB1",
                      "CPROB2",
                      "CPROB3",
                      "CPROB4",
                      "CPROB5",
                      "CPROB6",
                      "CB",
                      "CW",
                      "MLCJOINT",
                      "ID")

pp <- CW2CB3 %>% 
  group_by(CW) %>% 
  summarise(H0_1 = sum(H0 == 1)/length(H0), 
            H0_2 = sum(H0 == 2)/length(H0),
            H1_1 = sum(H1 == 1)/length(H1), 
            H1_2 = sum(H1 == 2)/length(H1),
            H2_1 = sum(H2 == 1)/length(H2), 
            H2_2 = sum(H2 == 2)/length(H2),
            H3_1 = sum(H3 == 1)/length(H3), 
            H3_2 = sum(H3 == 2)/length(H3),
            H4_1 = sum(H4 == 1)/length(H4), 
            H4_2 = sum(H4 == 2)/length(H4),
            H5_1 = sum(H5 == 1)/length(H5), 
            H5_2 = sum(H5 == 2)/length(H5),
            H6_1 = sum(H6 == 1)/length(H6), 
            H6_2 = sum(H6 == 2)/length(H6),
            H7_1 = sum(H7 == 1)/length(H7), 
            H7_2 = sum(H7 == 2)/length(H7),
            H8_1 = sum(H8 == 1)/length(H8), 
            H8_2 = sum(H8 == 2)/length(H8),
            H9_1 = sum(H9 == 1)/length(H9), 
            H9_2 = sum(H9 == 2)/length(H9),
            H10_1 = sum(H10 == 1)/length(H10), 
            H10_2 = sum(H10 == 2)/length(H10),
            H11_1 = sum(H11 == 1)/length(H11), 
            H11_2 = sum(H11 == 2)/length(H11),
            H12_1 = sum(H12 == 1)/length(H12), 
            H12_2 = sum(H12 == 2)/length(H12),
            H13_1 = sum(H13 == 1)/length(H13), 
            H13_2 = sum(H13 == 2)/length(H13),
            H14_1 = sum(H14 == 1)/length(H14), 
            H14_2 = sum(H14 == 2)/length(H14),
            H15_1 = sum(H15 == 1)/length(H15), 
            H15_2 = sum(H15 == 2)/length(H15),
            H16_1 = sum(H16 == 1)/length(H16), 
            H16_2 = sum(H16 == 2)/length(H16),
            H17_1 = sum(H17 == 1)/length(H17), 
            H17_2 = sum(H17 == 2)/length(H17),
            H18_1 = sum(H18 == 1)/length(H18), 
            H18_2 = sum(H18 == 2)/length(H18),
            H19_1 = sum(H19 == 1)/length(H19), 
            H19_2 = sum(H19 == 2)/length(H19),
            H20_1 = sum(H20 == 1)/length(H20), 
            H20_2 = sum(H20 == 2)/length(H20),
            H21_1 = sum(H21 == 1)/length(H21), 
            H21_2 = sum(H21 == 2)/length(H21),
            H22_1 = sum(H22 == 1)/length(H22), 
            H22_2 = sum(H22 == 2)/length(H22),
            H23_1 = sum(H23 == 1)/length(H23), 
            H23_2 = sum(H23 == 2)/length(H23))



pp_long <- pp %>% 
  gather(Hour, Prob, -CW) %>% 
  separate(Hour, into = c("HourN", "Carbo"), sep = "_") 




pp_long$HourN <- factor(pp_long$HourN, levels = c("H0","H1" ,"H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10","H11","H12","H13","H14","H15","H16","H17","H18","H19","H20","H21","H22","H23"))
```





## Visualisation of level 2 latent classes (CB = 3)




```{r echo=FALSE, fig.height=6, fig.width=7, message=FALSE, warning=FALSE, cache=TRUE}

ndnsNNN <- read_csv("results/ndnsNNN.dat")
dt <- ndnsNNN[, c(2,5)]
names(dt) <- c("ID_DAY", "DayofWeek")

# 
# CW3CB3_50 <- read_table2("results/50NDNS_CW3CB3.txt",
#                          col_names = FALSE)
# 
# names(CW3CB3_50) <- c("H0",
#                       "H1",
#                       "H2",
#                       "H3",
#                       "H4",
#                       "H5",
#                       "H6",
#                       "H7",
#                       "H8",
#                       "H9",
#                       "H10",
#                       "H11",
#                       "H12",
#                       "H13",
#                       "H14",
#                       "H15",
#                       "H16",
#                       "H17",
#                       "H18",
#                       "H19",
#                       "H20",
#                       "H21",
#                       "H22",
#                       "H23",
#                       "ID_DAY",
#                       "AGE",
#                       "SEX",
#                       "CPROB1",
#                       "CPROB2",
#                       "CPROB3",
#                       "CPROB4",
#                       "CPROB5",
#                       "CPROB6",
#                       "CPROB7",
#                       "CPROB8",
#                       "CPROB9",
#                       "CB",
#                       "CW",
#                       "MLCJOINT",
#                       "ID")





CW2CB3 <- CW2CB3 %>% 
  left_join(dt, by = "ID_DAY")


chart.data <- CW2CB3 %>% 
  group_by(CB, CW) %>% 
  tally %>% 
  group_by(CB) %>% 
  mutate(pct = n/sum(n))


chart.data$CW[chart.data$CW == 1] <- 0 
chart.data$CW[chart.data$CW == 3] <- 1 
chart.data$CW[chart.data$CW == 0] <- 3 

chart.data <- chart.data[order(chart.data$CB, chart.data$CW),]
chart.data <- ddply(chart.data, .(CB), 
                    transform, pos = cumsum(pct) - (0.5 * pct)) 



chart.data$CW <- factor(chart.data$CW, levels = c("3", "2"), 
                        labels = c("Lunch at 1 pm high carb breakfast", "Lunch at noon, eat until late"))
chart.data$CB <- factor(chart.data$CB, levels = c("1", "2", "3"), 
                        labels = c("Individual class 1\n(39.0%)",  "Individual class 2\n(28.05%)", 
                                   "Individual class 3\n(32.95%)"))



library(ggthemr)
ggthemr("dust", layout = "scientific")
ggplot() + 
  geom_bar(aes(y = pct, x = CB, fill = CW), data = chart.data, width = 0.6,
           stat="identity") + 
  geom_text(data=chart.data, aes(x = CB, y = pos, label = paste0(sprintf("%1.1f", pct*100),"%")),
            size=4, colour="white", family="Atlas Grotesk Medium") + 
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank(), 
        axis.title = element_text(size = 18), 
        axis.text = element_text(size = 15), 
        axis.line = element_line(colour = "black"), 
        plot.title=element_text(family="Atlas Grotesk Medium"),
        text=element_text(family="Atlas Grotesk Light")) + 
  labs(title = "Multilevel latent class solution", x = "Between Individual classes", y = "Percentage") +
  scale_y_continuous(labels=percent)
```


# (CW = 3) Level 1 latent classes



## Visualisation of level 1 latent classes 

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

CW3CB2 <- read_table2("results/50NDNS_CW3CB2.txt",
                         col_names = FALSE)

names(CW3CB2) <- c("H0",
                      "H1",
                      "H2",
                      "H3",
                      "H4",
                      "H5",
                      "H6",
                      "H7",
                      "H8",
                      "H9",
                      "H10",
                      "H11",
                      "H12",
                      "H13",
                      "H14",
                      "H15",
                      "H16",
                      "H17",
                      "H18",
                      "H19",
                      "H20",
                      "H21",
                      "H22",
                      "H23",
                      "ID_DAY",
                      "AGE",
                      "SEX",
                      "CPROB1",
                      "CPROB2",
                      "CPROB3",
                      "CPROB4",
                      "CPROB5",
                      "CPROB6",
                      "CB",
                      "CW",
                      "MLCJOINT",
                      "ID")

pp <- CW3CB2 %>% 
  group_by(CW) %>% 
  summarise(H0_0 = sum(H0 == 0)/length(H0), 
            H0_1 = sum(H0 == 1)/length(H0), 
            H0_2 = sum(H0 == 2)/length(H0),
            H1_0 = sum(H1 == 0)/length(H1),
            H1_1 = sum(H1 == 1)/length(H1), 
            H1_2 = sum(H1 == 2)/length(H1),
            H2_0 = sum(H2 == 0)/length(H2),
            H2_1 = sum(H2 == 1)/length(H2), 
            H2_2 = sum(H2 == 2)/length(H2),
            H3_0 = sum(H3 == 0)/length(H3),
            H3_1 = sum(H3 == 1)/length(H3), 
            H3_2 = sum(H3 == 2)/length(H3),
            H4_0 = sum(H4 == 0)/length(H4),
            H4_1 = sum(H4 == 1)/length(H4), 
            H4_2 = sum(H4 == 2)/length(H4),
            H5_0 = sum(H5 == 0)/length(H5),
            H5_1 = sum(H5 == 1)/length(H5), 
            H5_2 = sum(H5 == 2)/length(H5),
            H6_0 = sum(H6 == 0)/length(H6),
            H6_1 = sum(H6 == 1)/length(H6), 
            H6_2 = sum(H6 == 2)/length(H6),
            H7_0 = sum(H7 == 0)/length(H7),
            H7_1 = sum(H7 == 1)/length(H7), 
            H7_2 = sum(H7 == 2)/length(H7),
            H8_0 = sum(H8 == 0)/length(H8),
            H8_1 = sum(H8 == 1)/length(H8), 
            H8_2 = sum(H8 == 2)/length(H8),
            H9_0 = sum(H9 == 0)/length(H9),
            H9_1 = sum(H9 == 1)/length(H9), 
            H9_2 = sum(H9 == 2)/length(H9),
            H10_0 = sum(H10 == 0)/length(H10),
            H10_1 = sum(H10 == 1)/length(H10), 
            H10_2 = sum(H10 == 2)/length(H10),
            H11_0 = sum(H11 == 0)/length(H11),
            H11_1 = sum(H11 == 1)/length(H11), 
            H11_2 = sum(H11 == 2)/length(H11),
            H12_0 = sum(H12 == 0)/length(H12),
            H12_1 = sum(H12 == 1)/length(H12), 
            H12_2 = sum(H12 == 2)/length(H12),
            H13_0 = sum(H13 == 0)/length(H13),
            H13_1 = sum(H13 == 1)/length(H13), 
            H13_2 = sum(H13 == 2)/length(H13),
            H14_0 = sum(H14 == 0)/length(H14),
            H14_1 = sum(H14 == 1)/length(H14), 
            H14_2 = sum(H14 == 2)/length(H14),
            H15_0 = sum(H15 == 0)/length(H15),
            H15_1 = sum(H15 == 1)/length(H15), 
            H15_2 = sum(H15 == 2)/length(H15),
            H16_0 = sum(H16 == 0)/length(H16),
            H16_1 = sum(H16 == 1)/length(H16), 
            H16_2 = sum(H16 == 2)/length(H16),
            H17_0 = sum(H17 == 0)/length(H17),
            H17_1 = sum(H17 == 1)/length(H17), 
            H17_2 = sum(H17 == 2)/length(H17),
            H18_0 = sum(H18 == 0)/length(H18),
            H18_1 = sum(H18 == 1)/length(H18), 
            H18_2 = sum(H18 == 2)/length(H18),
            H19_0 = sum(H19 == 0)/length(H19),
            H19_1 = sum(H19 == 1)/length(H19), 
            H19_2 = sum(H19 == 2)/length(H19),
            H20_0 = sum(H20 == 0)/length(H20),
            H20_1 = sum(H20 == 1)/length(H20), 
            H20_2 = sum(H20 == 2)/length(H20),
            H21_0 = sum(H21 == 0)/length(H21),
            H21_1 = sum(H21 == 1)/length(H21), 
            H21_2 = sum(H21 == 2)/length(H21),
            H22_0 = sum(H22 == 0)/length(H22),
            H22_1 = sum(H22 == 1)/length(H22), 
            H22_2 = sum(H22 == 2)/length(H22),
            H23_0 = sum(H23 == 0)/length(H23),
            H23_1 = sum(H23 == 1)/length(H23), 
            H23_2 = sum(H23 == 2)/length(H23))



pp_long <- pp %>% 
  gather(Hour, Prob, -CW) %>% 
  separate(Hour, into = c("HourN", "Carbo"), sep = "_") 




pp_long$HourN <- factor(pp_long$HourN, levels = c("H0","H1" ,"H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10","H11","H12","H13","H14","H15","H16","H17","H18","H19","H20","H21","H22","H23"))
```




```{r echo=FALSE, fig.height=5, fig.width=14, message=FALSE, warning=FALSE, cache=TRUE}
library(ggthemr)
ggthemr("fresh", layout = "scientific")
library(ggplot2)


ggplot(pp_long[pp_long$CW == 1, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.5) + 
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 18), 
        axis.line = element_line(colour = "black"), 
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        legend.text = element_text(size = 15), 
        legend.title = element_text(size = 15) 
        # legend.position = "bottom", 
        # legend.direction = "horizontal"
  ) + 
  labs(title = "Class 1 Lunch at noon, high carb breakfast", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") + 
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))



ggplot(pp_long[pp_long$CW == 2, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.5) + 
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 18), 
        axis.line = element_line(colour = "black"), 
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        legend.text = element_text(size = 15), 
        legend.title = element_text(size = 15) 
        # legend.position = "bottom", 
        # legend.direction = "horizontal"
  ) + 
  labs(title = "Class 2 Low carb at 6pm", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") + 
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))


# 
# 
ggplot(pp_long[pp_long$CW == 3, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) +
  geom_point(size = 3) +
  geom_line(size = 1.5) +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 18),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15)
        # legend.position = "bottom",
        # legend.direction = "horizontal"
  ) +
  labs(title = "Class 3 Lunch at 1 pm, low carb at night", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") +
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))

# 
# 
# ggplot(pp_long[pp_long$Class == 4, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
#   geom_point(size = 3) + 
#   geom_line(size = 1.5) + 
#   theme(axis.title = element_text(size = 18), 
#         axis.text = element_text(size = 18), 
#         axis.line = element_line(colour = "black"), 
#         panel.border = element_blank(), 
#         panel.background = element_blank(), 
#         legend.text = element_text(size = 15), 
#         legend.title = element_text(size = 15) 
#         # legend.position = "bottom", 
#         # legend.direction = "horizontal"
#   ) + 
#   labs(title = "Class 4 Low carb all day", x = "Hour of the day", y = "Probability",
#        color = "Carbohydrate\nintake") + 
#   scale_color_discrete(labels = c("< 50%", ">= 50%")) + 
#   ylim(c(0,1))
```

## Visualisation of level 2 latent classes (CB = 2)


```{r echo=FALSE, fig.height=6, fig.width=7, message=FALSE, warning=FALSE, cache=TRUE}

ndnsNNN <- read_csv("results/ndnsNNN.dat")
dt <- ndnsNNN[, c(2,5)]
names(dt) <- c("ID_DAY", "DayofWeek")


CW3CB2 <- CW3CB2 %>% 
  left_join(dt, by = "ID_DAY")


chart.data <- CW3CB2 %>% 
  group_by(CB, CW) %>% 
  tally %>% 
  group_by(CB) %>% 
  mutate(pct = n/sum(n))

chart.data <- ddply(chart.data, .(CB),
                     transform, pos = cumsum(pct) - (0.5 * pct))

chart.data$CW <- factor(chart.data$CW, levels = c("3", "2", "1"), 
                        labels = c("Lunch at 1 pm,\nlow carb at night", "Low carb at 6pm", "Lunch at noon,\nhigh carb breakfast"))
chart.data$CB <- factor(chart.data$CB, levels = c("1", "2"), 
                        labels = c("Individual class 1\n(60.06%)",  "Individual class 2\n(39.94%)"))



library(ggthemr)
ggthemr("dust", layout = "scientific")
ggplot() + 
  geom_bar(aes(y = pct, x = CB, fill = CW), data = chart.data, width = 0.6,
           stat="identity") + 
  geom_text(data=chart.data, aes(x = CB, y = pos, label = paste0(sprintf("%1.1f", pct*100),"%")),
            size=4, colour="white", family="Atlas Grotesk Medium") + 
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank(), 
        axis.title = element_text(size = 18), 
        axis.text = element_text(size = 15), 
        axis.line = element_line(colour = "black"), 
        plot.title=element_text(family="Atlas Grotesk Medium"),
        text=element_text(family="Atlas Grotesk Light")) + 
  labs(title = "Multilevel latent class solution", x = "Between Individual classes", y = "Percentage") +
  scale_y_continuous(labels=percent)
```





## Visualisation of level 2 latent classes (CB = 3)




```{r message=FALSE, warning=FALSE, echo=FALSE, paged.print=FALSE}

CW3CB3 <- read_table2("results/50NDNS_CW3CB3.txt",
                         col_names = FALSE)

names(CW3CB3) <- c("H0",
                      "H1",
                      "H2",
                      "H3",
                      "H4",
                      "H5",
                      "H6",
                      "H7",
                      "H8",
                      "H9",
                      "H10",
                      "H11",
                      "H12",
                      "H13",
                      "H14",
                      "H15",
                      "H16",
                      "H17",
                      "H18",
                      "H19",
                      "H20",
                      "H21",
                      "H22",
                      "H23",
                      "ID_DAY",
                      "AGE",
                      "SEX",
                      "CPROB1",
                      "CPROB2",
                      "CPROB3",
                      "CPROB4",
                      "CPROB5",
                      "CPROB6",
                      "CPROB7",
                      "CPROB8",
                      "CPROB9",
                      "CB",
                      "CW",
                      "MLCJOINT",
                      "ID")




ndnsNNN <- read_csv("results/ndnsNNN.dat")
dt <- ndnsNNN[, c(2,5)]
names(dt) <- c("ID_DAY", "DayofWeek")


CW3CB3 <- CW3CB3 %>% 
  left_join(dt, by = "ID_DAY")


chart.data <- CW3CB3 %>% 
  group_by(CB, CW) %>% 
  tally %>% 
  group_by(CB) %>% 
  mutate(pct = n/sum(n))

chart.data <- ddply(chart.data, .(CB),
                     transform, pos = cumsum(pct) - (0.5 * pct))

chart.data$CW <- factor(chart.data$CW, levels = c("3", "2", "1"), 
                        labels = c("Lunch at 1 pm,\nlow carb at night", "Low carb at 6pm", "Lunch at noon,\nhigh carb breakfast"))
chart.data$CB <- factor(chart.data$CB, levels = c("1", "2", "3"), 
                        labels = c("Individual class 1\n(41.76%)",  "Individual class 2\n(27.25%)", "Individual class 3\n(30.10%)"))



library(ggthemr)
ggthemr("dust", layout = "scientific")
ggplot() + 
  geom_bar(aes(y = pct, x = CB, fill = CW), data = chart.data, width = 0.6,
           stat="identity") + 
  geom_text(data=chart.data, aes(x = CB, y = pos, label = paste0(sprintf("%1.1f", pct*100),"%")),
            size=4, colour="white", family="Atlas Grotesk Medium") + 
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank(), 
        axis.title = element_text(size = 18), 
        axis.text = element_text(size = 15), 
        axis.line = element_line(colour = "black"), 
        plot.title=element_text(family="Atlas Grotesk Medium"),
        text=element_text(family="Atlas Grotesk Light")) + 
  labs(title = "Multilevel latent class solution", x = "Between Individual classes", y = "Percentage") +
  scale_y_continuous(labels=percent)
```

# (CW = 4) Level 1 latent classes



## Visualisation of level 1 latent classes 

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

CW4CB2 <- read_table2("results/50NDNS_CW4CB2.txt",
                         col_names = FALSE)

names(CW4CB2) <- c("H0",
                      "H1",
                      "H2",
                      "H3",
                      "H4",
                      "H5",
                      "H6",
                      "H7",
                      "H8",
                      "H9",
                      "H10",
                      "H11",
                      "H12",
                      "H13",
                      "H14",
                      "H15",
                      "H16",
                      "H17",
                      "H18",
                      "H19",
                      "H20",
                      "H21",
                      "H22",
                      "H23",
                      "ID_DAY",
                      "AGE",
                      "SEX",
                      "CPROB1",
                      "CPROB2",
                      "CPROB3",
                      "CPROB4",
                      "CPROB5",
                      "CPROB6",
                      "CPROB7",
                      "CPROB8",
                      "CB",
                      "CW",
                      "MLCJOINT",
                      "ID")

pp <- CW4CB2 %>% 
  group_by(CW) %>% 
  summarise(H0_0 = sum(H0 == 0)/length(H0), 
            H0_1 = sum(H0 == 1)/length(H0), 
            H0_2 = sum(H0 == 2)/length(H0),
            H1_0 = sum(H1 == 0)/length(H1),
            H1_1 = sum(H1 == 1)/length(H1), 
            H1_2 = sum(H1 == 2)/length(H1),
            H2_0 = sum(H2 == 0)/length(H2),
            H2_1 = sum(H2 == 1)/length(H2), 
            H2_2 = sum(H2 == 2)/length(H2),
            H3_0 = sum(H3 == 0)/length(H3),
            H3_1 = sum(H3 == 1)/length(H3), 
            H3_2 = sum(H3 == 2)/length(H3),
            H4_0 = sum(H4 == 0)/length(H4),
            H4_1 = sum(H4 == 1)/length(H4), 
            H4_2 = sum(H4 == 2)/length(H4),
            H5_0 = sum(H5 == 0)/length(H5),
            H5_1 = sum(H5 == 1)/length(H5), 
            H5_2 = sum(H5 == 2)/length(H5),
            H6_0 = sum(H6 == 0)/length(H6),
            H6_1 = sum(H6 == 1)/length(H6), 
            H6_2 = sum(H6 == 2)/length(H6),
            H7_0 = sum(H7 == 0)/length(H7),
            H7_1 = sum(H7 == 1)/length(H7), 
            H7_2 = sum(H7 == 2)/length(H7),
            H8_0 = sum(H8 == 0)/length(H8),
            H8_1 = sum(H8 == 1)/length(H8), 
            H8_2 = sum(H8 == 2)/length(H8),
            H9_0 = sum(H9 == 0)/length(H9),
            H9_1 = sum(H9 == 1)/length(H9), 
            H9_2 = sum(H9 == 2)/length(H9),
            H10_0 = sum(H10 == 0)/length(H10),
            H10_1 = sum(H10 == 1)/length(H10), 
            H10_2 = sum(H10 == 2)/length(H10),
            H11_0 = sum(H11 == 0)/length(H11),
            H11_1 = sum(H11 == 1)/length(H11), 
            H11_2 = sum(H11 == 2)/length(H11),
            H12_0 = sum(H12 == 0)/length(H12),
            H12_1 = sum(H12 == 1)/length(H12), 
            H12_2 = sum(H12 == 2)/length(H12),
            H13_0 = sum(H13 == 0)/length(H13),
            H13_1 = sum(H13 == 1)/length(H13), 
            H13_2 = sum(H13 == 2)/length(H13),
            H14_0 = sum(H14 == 0)/length(H14),
            H14_1 = sum(H14 == 1)/length(H14), 
            H14_2 = sum(H14 == 2)/length(H14),
            H15_0 = sum(H15 == 0)/length(H15),
            H15_1 = sum(H15 == 1)/length(H15), 
            H15_2 = sum(H15 == 2)/length(H15),
            H16_0 = sum(H16 == 0)/length(H16),
            H16_1 = sum(H16 == 1)/length(H16), 
            H16_2 = sum(H16 == 2)/length(H16),
            H17_0 = sum(H17 == 0)/length(H17),
            H17_1 = sum(H17 == 1)/length(H17), 
            H17_2 = sum(H17 == 2)/length(H17),
            H18_0 = sum(H18 == 0)/length(H18),
            H18_1 = sum(H18 == 1)/length(H18), 
            H18_2 = sum(H18 == 2)/length(H18),
            H19_0 = sum(H19 == 0)/length(H19),
            H19_1 = sum(H19 == 1)/length(H19), 
            H19_2 = sum(H19 == 2)/length(H19),
            H20_0 = sum(H20 == 0)/length(H20),
            H20_1 = sum(H20 == 1)/length(H20), 
            H20_2 = sum(H20 == 2)/length(H20),
            H21_0 = sum(H21 == 0)/length(H21),
            H21_1 = sum(H21 == 1)/length(H21), 
            H21_2 = sum(H21 == 2)/length(H21),
            H22_0 = sum(H22 == 0)/length(H22),
            H22_1 = sum(H22 == 1)/length(H22), 
            H22_2 = sum(H22 == 2)/length(H22),
            H23_0 = sum(H23 == 0)/length(H23),
            H23_1 = sum(H23 == 1)/length(H23), 
            H23_2 = sum(H23 == 2)/length(H23))



pp_long <- pp %>% 
  gather(Hour, Prob, -CW) %>% 
  separate(Hour, into = c("HourN", "Carbo"), sep = "_") 




pp_long$HourN <- factor(pp_long$HourN, levels = c("H0","H1" ,"H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10","H11","H12","H13","H14","H15","H16","H17","H18","H19","H20","H21","H22","H23"))
```




```{r echo=FALSE, fig.height=5, fig.width=14, message=FALSE, warning=FALSE, cache=TRUE}
library(ggthemr)
ggthemr("fresh", layout = "scientific")
library(ggplot2)


ggplot(pp_long[pp_long$CW == 1, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.5) + 
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 18), 
        axis.line = element_line(colour = "black"), 
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        legend.text = element_text(size = 15), 
        legend.title = element_text(size = 15) 
        # legend.position = "bottom", 
        # legend.direction = "horizontal"
  ) + 
  labs(title = "Class 1 Lunch at noon, low carb 5pm,\nhigh carb breakfast", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") + 
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))



ggplot(pp_long[pp_long$CW == 2, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.5) + 
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 18), 
        axis.line = element_line(colour = "black"), 
        panel.border = element_blank(), 
        panel.background = element_blank(), 
        legend.text = element_text(size = 15), 
        legend.title = element_text(size = 15) 
        # legend.position = "bottom", 
        # legend.direction = "horizontal"
  ) + 
  labs(title = "Class 2 Lunch at noon, low carb 6pm,\nhigh carb breakfast", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") + 
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))


# 
# 
ggplot(pp_long[pp_long$CW == 3, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) +
  geom_point(size = 3) +
  geom_line(size = 1.5) +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 18),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15)
        # legend.position = "bottom",
        # legend.direction = "horizontal"
  ) +
  labs(title = "Class 3 Low carb late lunch (2pm) and \nLow carb dinner (7pm)", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") +
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))



ggplot(pp_long[pp_long$CW == 4, ], aes(y = Prob, x=HourN, group = Carbo, color = Carbo)) +
  geom_point(size = 3) +
  geom_line(size = 1.5) +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 18),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 15)
        # legend.position = "bottom",
        # legend.direction = "horizontal"
  ) +
  labs(title = "Class 4 Low carb lunch (1pm) and \nLow carb dinner (7pm)", x = "Hour of the day", y = "Probability",
       color = "Carbohydrate\nintake") +
  scale_color_discrete(labels = c("Not eating", "< 50%", ">= 50%")) + 
  ylim(c(0,1))
```





## Visualisation of level 2 latent classes (CB = 2)


```{r echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, cache=TRUE}

ndnsNNN <- read_csv("results/ndnsNNN.dat")
dt <- ndnsNNN[, c(2,5)]
names(dt) <- c("ID_DAY", "DayofWeek")


CW4CB2 <- CW4CB2 %>% 
  left_join(dt, by = "ID_DAY")


chart.data <- CW4CB2 %>% 
  group_by(CB, CW) %>% 
  tally %>% 
  group_by(CB) %>% 
  mutate(pct = n/sum(n))

chart.data <- ddply(chart.data, .(CB),
                     transform, pos = cumsum(pct) - (0.5 * pct))

chart.data$CW <- factor(chart.data$CW, levels = c("4", "3", "2", "1"), 
                        labels = c("Low carb lunch (1pm) and \nLow carb dinner (7pm)", 
                                   "Low carb late\n lunch (2pm) and \nLow carb dinner (7pm)", 
                                   "Lunch at noon,\n low carb 6pm,\nhigh carb breakfast", 
                                   "Lunch at noon,\n low carb 5pm,\nhigh carb breakfast"))
chart.data$CB <- factor(chart.data$CB, levels = c("1", "2"), 
                        labels = c("Individual class 1\n(59.81%)",  "Individual class 2\n(40.19%)"))



library(ggthemr)
ggthemr("dust", layout = "scientific")
ggplot() + 
  geom_bar(aes(y = pct, x = CB, fill = CW), data = chart.data, width = 0.6,
           stat="identity") + 
  geom_text(data=chart.data, aes(x = CB, y = pos, label = paste0(sprintf("%1.1f", pct*100),"%")),
            size=4, colour="white", family="Atlas Grotesk Medium") + 
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank(), 
        axis.title = element_text(size = 18), 
        axis.text = element_text(size = 15), 
        axis.line = element_line(colour = "black"), 
        plot.title=element_text(family="Atlas Grotesk Medium"),
        text=element_text(family="Atlas Grotesk Light")) + 
  labs(title = "Multilevel latent class solution", x = "Between Individual classes", y = "Percentage") +
  scale_y_continuous(labels=percent)
```



<!-- ## Visualisation of level 2 latent classes (CB = 4) -->


<!-- ```{r echo=FALSE, fig.height=6, fig.width=7, message=FALSE, warning=FALSE, cache=TRUE} -->



<!-- CW2CB4_50 <- read_table2("results/50NDNS_CW2CB4.txt", -->
<!--                          col_names = FALSE) -->

<!-- names(CW2CB4_50) <- c("H0", -->
<!--                       "H1", -->
<!--                       "H2", -->
<!--                       "H3", -->
<!--                       "H4", -->
<!--                       "H5", -->
<!--                       "H6", -->
<!--                       "H7", -->
<!--                       "H8", -->
<!--                       "H9", -->
<!--                       "H10", -->
<!--                       "H11", -->
<!--                       "H12", -->
<!--                       "H13", -->
<!--                       "H14", -->
<!--                       "H15", -->
<!--                       "H16", -->
<!--                       "H17", -->
<!--                       "H18", -->
<!--                       "H19", -->
<!--                       "H20", -->
<!--                       "H21", -->
<!--                       "H22", -->
<!--                       "H23", -->
<!--                       "ID_DAY", -->
<!--                       "AGE", -->
<!--                       "SEX", -->
<!--                       "CPROB1", -->
<!--                       "CPROB2", -->
<!--                       "CPROB3", -->
<!--                       "CPROB4", -->
<!--                       "CPROB5", -->
<!--                       "CPROB6", -->
<!--                       "CPROB7", -->
<!--                       "CPROB8", -->
<!--                       # "CPROB9", -->
<!--                       # "CPROB10", -->
<!--                       # "CPROB11", -->
<!--                       # "CPROB12", -->
<!--                       "CB", -->
<!--                       "CW", -->
<!--                       "MLCJOINT", -->
<!--                       "ID") -->


<!-- #CW3CB4_50$ID_DAY <- CW3CB3_50$ID_DAY -->


<!-- CW2CB4_50 <- CW2CB4_50 %>% -->
<!--   left_join(dt, by = "ID_DAY") -->


<!-- chart.data <- CW2CB4_50 %>% -->
<!--   group_by(CB, CW) %>% -->
<!--   tally %>% -->
<!--   group_by(CB) %>% -->
<!--   mutate(pct = n/sum(n)) -->

<!-- chart.data$CW[chart.data$CW == 1] <- 0 -->
<!-- chart.data$CW[chart.data$CW == 3] <- 1 -->
<!-- chart.data$CW[chart.data$CW == 0] <- 3 -->

<!-- chart.data <- chart.data[order(chart.data$CB, chart.data$CW),] -->


<!-- chart.data <- ddply(chart.data, .(CB), -->
<!--                      transform, pos = cumsum(pct) - (0.5 * pct)) -->




<!-- chart.data$CW <- factor(chart.data$CW, levels = c("3", "2", "1"), -->
<!--                         labels = c("late lunch at 1 pm", "low-carb all day till night", "Lunch at noon")) -->

<!-- chart.data$CB <- factor(chart.data$CB, levels = c("1", "2", "3", "4"), -->
<!--                         labels = c("Individual\n class 1\n(20.65%)",  "Individual\n class 2\n(25.68%)", -->
<!--                                    "Individual\n class 3\n(23.87%)", "Individual\n class 3\n(29.80%)")) -->



<!-- library(ggthemr) -->
<!-- ggthemr("dust", layout = "scientific") -->
<!-- ggplot() + -->
<!--   geom_bar(aes(y = pct, x = CB, fill = CW), data = chart.data, width = 0.6, -->
<!--            stat="identity") + -->
<!--   geom_text(data=chart.data, aes(x = CB, y = pos, label = paste0(sprintf("%1.1f", pct*100),"%")), -->
<!--             size=4, colour="white", family="Atlas Grotesk Medium") + -->
<!--   theme(legend.position="bottom", legend.direction="horizontal", -->
<!--         legend.title = element_blank(), -->
<!--         axis.title = element_text(size = 18), -->
<!--         axis.text = element_text(size = 13), -->
<!--         axis.line = element_line(colour = "black"), -->
<!--         plot.title=element_text(family="Atlas Grotesk Medium"), -->
<!--         text=element_text(family="Atlas Grotesk Light")) + -->
<!--   labs(title = "Multilevel latent class solution", x = "Between Individual classes", y = "Percentage") + -->
<!--   scale_y_continuous(labels=percent) -->
<!-- ``` -->

